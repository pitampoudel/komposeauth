<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset Password</title>
    <style>
        :root {
            --bg: #f7f7fb;
            --card-bg: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --primary: #2563eb;
            --primary-600: #1d4ed8;
            --border: #e5e7eb;
            --success: #065f46;
            --error: #b91c1c;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0b0f17;
                --card-bg: #0f172a;
                --text: #e5e7eb;
                --muted: #9ca3af;
                --primary: #3b82f6;
                --primary-600: #2563eb;
                --border: #1f2937;
            }
        }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            display: grid;
            place-items: center;
            background: var(--bg);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.5;
        }
        .card {
            width: min(92vw, 420px);
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.06);
            padding: 28px;
        }
        .header {
            margin-bottom: 18px;
            text-align: center;
        }
        .title {
            margin: 0 0 6px;
            font-size: 1.375rem;
            letter-spacing: -0.01em;
        }
        .subtitle {
            margin: 0;
            color: var(--muted);
            font-size: 0.95rem;
        }
        .field { margin-top: 14px; }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        input[type="password"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--text);
            outline: none;
            transition: border-color .15s ease, box-shadow .15s ease;
        }
        input[type="password"]:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 25%, transparent);
        }
        .btn {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 18px;
            padding: 12px 16px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: background .2s ease, transform .02s ease;
        }
        .btn:hover { background: var(--primary-600); }
        .btn:active { transform: translateY(1px); }
        .note { margin-top: 10px; color: var(--muted); font-size: .9rem; }
        .alert {
            border-radius: 10px;
            padding: 10px 12px;
            font-size: 0.92rem;
            margin-bottom: 12px;
        }
        .alert.success { background: color-mix(in srgb, #10b981 12%, transparent); color: var(--success); border: 1px solid color-mix(in srgb, #10b981 25%, transparent); }
        .alert.error { background: color-mix(in srgb, #ef4444 12%, transparent); color: var(--error); border: 1px solid color-mix(in srgb, #ef4444 25%, transparent); }
        .footer { margin-top: 14px; text-align: center; color: var(--muted); font-size: 0.85rem; }
        .logo {
            width: 40px; height: 40px; border-radius: 10px; display: inline-grid; place-items: center; margin-bottom: 8px;
            background: color-mix(in srgb, var(--primary) 18%, transparent); color: var(--primary);
            font-weight: 800; font-size: 0.95rem;
        }
        .logo-img {
            width: 40px; height: 40px; border-radius: 10px; margin-bottom: 8px; object-fit: contain; display: inline-block;
        }
        .hidden { display: none; }
    </style>
</head>

<body>
    <main class="card" role="main">
        <div class="header">
            <img th:if="${logoUrl}" th:src="${logoUrl}" alt="Logo" class="logo-img" />
            <div class="logo" aria-hidden="true" th:if="${logoUrl} == null">KA</div>
            <h1 class="title">Reset your password</h1>
            <p class="subtitle">Choose a strong, unique password you don't use elsewhere.</p>
        </div>

        <!-- Optional status messages (server-rendered) -->
        <div th:if="${message}" class="alert success" th:text="${message}"></div>
        <div th:if="${error}" class="alert error" th:text="${error}"></div>
        <!-- Client-side status message -->
        <div id="clientAlert" class="alert hidden" role="alert" aria-live="polite"></div>

        <form th:action="@{/reset-password}" method="post" novalidate>
            <input type="hidden" name="token" th:value="${token}" />

            <div class="field">
                <label for="newPassword">New password</label>
                <input type="password" id="newPassword" name="newPassword" minlength="8" autocomplete="new-password" required />
                <div class="note">At least 8 characters; use letters, numbers, and symbols.</div>
            </div>

            <div class="field">
                <label for="confirmPassword">Confirm new password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password" required />
            </div>

            <button class="btn" id="submitBtn" type="submit">Reset password</button>
            <div class="footer" id="footerNote" aria-hidden="true">Submit to reset your password.</div>
        </form>
    </main>
    <script>
        (function() {
            const form = document.querySelector('form');
            const submitBtn = document.getElementById('submitBtn');
            const alertBox = document.getElementById('clientAlert');
            const footerNote = document.getElementById('footerNote');
            if (!form) return;

            function showAlert(type, message) {
                alertBox.classList.remove('hidden', 'success', 'error');
                alertBox.classList.add(type === 'success' ? 'success' : 'error');
                alertBox.textContent = message;
            }

            function hideAlert() {
                alertBox.classList.add('hidden');
                alertBox.textContent = '';
                alertBox.classList.remove('success', 'error');
            }

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                hideAlert();

                const token = form.querySelector('input[name="token"]').value;
                const newPassword = /** @type {HTMLInputElement} */(document.getElementById('newPassword')).value;
                const confirmPassword = /** @type {HTMLInputElement} */(document.getElementById('confirmPassword')).value;

                // Basic client-side validation
                if (!newPassword || newPassword.length < 8) {
                    showAlert('error', 'Password must be at least 8 characters.');
                    document.getElementById('newPassword').focus();
                    return;
                }
                if (newPassword !== confirmPassword) {
                    showAlert('error', 'Passwords do not match.');
                    document.getElementById('confirmPassword').focus();
                    return;
                }

                // Build headers with potential CSRF token support
                // Controller expects @RequestParam style (form-url-encoded), not JSON
                const headers = {
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                    'Accept': 'application/json'
                };
                // Try common Spring Security cookie name (XSRF-TOKEN)
                const csrfFromCookie = getCookie('XSRF-TOKEN');
                if (csrfFromCookie) {
                    headers['X-XSRF-TOKEN'] = csrfFromCookie;
                }

                // Loading state
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Please waitâ€¦';

                try {
                    const body = new URLSearchParams({ token, newPassword, confirmPassword });
                    const res = await fetch(form.action, {
                        method: 'POST',
                        headers,
                        body
                    });

                    let payload = null;
                    const ct = res.headers.get('Content-Type') || '';
                    if (ct.includes('application/json')) {
                        payload = await res.json().catch(() => null);
                    } else {
                        payload = { message: await res.text().catch(() => '') };
                    }

                    if (res.ok) {
                        showAlert('success', (payload && (payload.message || payload.success)) || 'Password reset successful.');
                        footerNote.textContent = 'You can now sign in with your new password.';
                        // Optionally disable inputs after success
                        form.querySelectorAll('input, button').forEach(el => el.disabled = true);
                    } else {
                        const errMsg = (payload && (payload.error || payload.message)) || 'Unable to reset password.';
                        showAlert('error', errMsg);
                    }
                } catch (err) {
                    showAlert('error', 'Network error. Please try again.');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            });
        })();
    </script>
</body>

</html>